{% load dashboard_extras %}
{% load switch_case %}
{% load timedelta %}
{% load device_count_in_zone %}
{% load check_false %}
<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en"><!--<![endif]-->
<!-- BEGIN HEAD -->
<head>
        <meta charset="utf-8">
        <title>PEA Smart Home</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta content="width=device-width, initial-scale=1" name="viewport">
        <meta content="PEA Smart Home" name="description">
        <meta content="" name="author">
        <!-- BEGIN GLOBAL MANDATORY STYLES -->
        <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&amp;subset=all" rel="stylesheet" type="text/css">
        <link href="/static/newassets/global/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="/static/newassets/global/plugins/simple-line-icons/simple-line-icons.min.css" rel="stylesheet" type="text/css">
        <link href="/static/newassets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="/static/newassets/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css" rel="stylesheet" type="text/css">
        <!-- END GLOBAL MANDATORY STYLES -->
        <!-- BEGIN PAGE LEVEL PLUGINS -->
	<link href="/static/newassets/global/plugins/datatables/datatables.min.css" rel="stylesheet" type="text/css" />
        <link href="/static/newassets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css" rel="stylesheet" type="text/css" />
        <!-- END PAGE LEVEL PLUGINS -->
        <!-- BEGIN THEME GLOBAL STYLES -->
        <link href="/static/newassets/global/css/components.min.css" rel="stylesheet" id="style_components" type="text/css">
        <link href="/static/newassets/global/css/plugins.min.css" rel="stylesheet" type="text/css">
        <!-- END THEME GLOBAL STYLES -->
        <!-- BEGIN THEME LAYOUT STYLES -->
        <link href="/static/newassets/layouts/layout4/css/layout.min.css" rel="stylesheet" type="text/css">
        <link href="/static/newassets/layouts/layout4/css/themes/default.min.css" rel="stylesheet" type="text/css" id="style_color">
        <link href="/static/newassets/layouts/layout4/css/custom.min.css" rel="stylesheet" type="text/css">

        <link href="/static/newassets/custom/font/flaticon.css" rel="stylesheet" type="text/css">
        <link href="/static/newassets/custom/custom.css" rel="stylesheet" type="text/css">
        <!-- END THEME LAYOUT STYLES -->
        <link rel="shortcut icon" href="favicon.ico"> <style type="text/css">.jqstooltip { position: absolute;left: 0px;top: 0px;visibility: hidden;background: rgb(0, 0, 0) transparent;background-color: rgba(0,0,0,0.6);filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=#99000000, endColorstr=#99000000);-ms-filter: "progid:DXImageTransform.Microsoft.gradient(startColorstr=#99000000, endColorstr=#99000000)";color: white;font: 10px arial, san serif;text-align: left;white-space: nowrap;padding: 5px;border: 1px solid white;z-index: 10000;}.jqsfield { color: white;font: 10px arial, san serif;text-align: left;}</style>
        <script>
function setValue() {
  //User Information
  update_Username("admin");

  //Current Rate
  update_Cur_rate("4.32");
}
        </script>
      </head>
    <!-- END HEAD -->

    <body class="page-container-bg-solid page-sidebar-closed-hide-logo page-header-fixed">
        <!-- BEGIN HEADER -->
        {% include 'top_nav.html' %}
        <!-- END HEADER -->
        <!-- BEGIN HEADER & CONTENT DIVIDER -->
        <div class="clearfix"> </div>
        <!-- END HEADER & CONTENT DIVIDER -->
        <!-- BEGIN CONTAINER -->
        <div class="page-container">
            <!-- BEGIN SIDEBAR -->
            {% include 'sidebar.html' %}
            <!-- END SIDEBAR -->
            <!-- BEGIN CONTENT -->
            <div class="page-content-wrapper">
                <!-- BEGIN CONTENT BODY -->
                <div class="page-content" style="min-height: 981px;">
                    <!-- BEGIN page_breadcrumb -->
                    {% include 'page_breadcrumb.html' %}
                    <!-- END page_breadcrumb -->
                    <br>
                    <!-- BEGIN PAGE HEAD-->
                    <!--<div class="page-head">-->
                        <!-- BEGIN PAGE TITLE -->
                        <!--<div class="page-title">
                            <h1>Dashboard
                            </h1>
                        </div>-->
                        <!-- END PAGE TITLE -->

                    <!--</div>-->
                    <!-- END PAGE HEAD-->
                    <!-- BEGIN PAGE BREADCRUMB -->
                    <!--<ul class="page-breadcrumb breadcrumb">
                        <li>
                            <a href="index.html">Home</a>
                            <i class="fa fa-circle"></i>
                        </li>
                        <li>
                            <span class="active">Dashboard</span>
                        </li>
                    </ul>-->
                    <!-- END PAGE BREADCRUMB -->
                    <div class="row">
                        <div class="col-lg-12 col-xs-12 col-sm-12">
                            <!-- BEGIN PORTLET-->
                            <div class="portlet light bordered">
                                <div class="portlet-title tabbable-line">
                                    <div class="caption">
                                        <i class="icon-bubbles font-dark hide"></i>
                                        <span class="caption-subject font-dark bold uppercase">Manage Users</span>
                                    </div>
                                </div>
                                <div class="portlet-body">
					{% csrf_token %}
                                    <table class="table table-striped table-hover table-bordered" id="sample_editable_1">
                                            <thead>
                                                <tr>
                                                    <th> Name </th>
                                                    <th> Email </th>
                                                    <th> Role </th>
                                                    <th style="max-width:125px"> Registered On </th>
                                                    <th style="max-width:125px"> Last Login </th>
                                                    <th style="min-width:70px"> Edit </th>
                                                    <th style="max-width:30px"> Delete </th>
                                                </tr>
                                            </thead>
                                            <tbody>
						{% for usr in users %}
                                                <tr style="height:45px" id="id-{{ usr.id }}">
                                                    <td> {{ usr.first_name }} {{ usr.last_name }} </td>
                                                    <td> {{ usr.email }} </td>
                                                    <td>
{% if usr.is_active|is_false %}
    Unapproved
{% elif usr.get_profile.group.name == "Admin" %}
    Admin
{% elif usr.get_profile.group.name == "Zone Manager" %}
    Tenant
{% elif usr.get_profile.group.name == "Tenant" %}
    Guest
{% endif %}
</td>
                                                    <td> {{ usr.date_joined }} </td>
                                                    <td> {{ usr.last_login }} </td>
                                                    <td>
                                                        <a class="btn yellow-saffron btn-xs edit" href="javascript:;" {% if usr.username == 'admin' and usr.username != request.user %}
                    disabled="disabled"
                    {% endif %}> Edit </a>
                                                    </td>
                                                    <td>
                                                        <a class="btn red btn-xs delete" href="javascript:;" {% if usr.username == 'admin' and usr.username != request.user %}
                    disabled="disabled"
                    {% endif %}> Delete </a>
                                                    </td>
                                                </tr>
						{%  endfor  %}
                                            </tbody>
                                        </table>
                                </div>
                            </div>
                            <!-- END PORTLET-->
                        </div>
                    </div>

                </div>
                <!-- END CONTENT BODY -->
            </div>
            <!-- END CONTENT -->
        </div>
        <!-- END CONTAINER -->
        <!--[if lt IE 9]>
<script src="/static/newassets/global/plugins/respond.min.js"></script>
<script src="/static/newassets/global/plugins/excanvas.min.js"></script>
<script src="/static/newassets/global/plugins/ie8.fix.min.js"></script>
<![endif]-->
        <!-- BEGIN CORE PLUGINS -->
        <script src="/static/newassets/global/plugins/jquery.min.js" type="text/javascript"></script>
        <script src="/static/newassets/global/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="/static/newassets/global/plugins/js.cookie.min.js" type="text/javascript"></script>
        <script src="/static/newassets/global/plugins/jquery-slimscroll/jquery.slimscroll.min.js" type="text/javascript"></script>
        <script src="/static/newassets/global/plugins/jquery.blockui.min.js" type="text/javascript"></script>
        <script src="/static/newassets/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js" type="text/javascript"></script>
        <!-- END CORE PLUGINS -->
        <!-- BEGIN PAGE LEVEL PLUGINS -->
        <!-- END PAGE LEVEL PLUGINS -->
        <!-- BEGIN THEME GLOBAL SCRIPTS -->
        <script src="/static/newassets/global/scripts/app.min.js" type="text/javascript"></script>
        <!-- END THEME GLOBAL SCRIPTS -->
        <!-- BEGIN PAGE LEVEL SCRIPTS -->
	<script src="/static/newassets/global/scripts/datatable.js" type="text/javascript"></script>
	<script src="/static/newassets/global/plugins/datatables/datatables.min.js" type="text/javascript"></script>
	<script src="/static/newassets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js" type="text/javascript"></script>
	<script class="include" type="text/javascript" src="/static/app_js/jquery.csrftoken.js"></script>
        <!-- END PAGE LEVEL SCRIPTS -->
        <!-- BEGIN THEME LAYOUT SCRIPTS -->
        <script src="/static/newassets/layouts/layout4/scripts/layout.min.js" type="text/javascript"></script>
        <script src="/static/newassets/layouts/layout4/scripts/demo.min.js" type="text/javascript"></script>
        <script src="/static/newassets/layouts/global/scripts/quick-sidebar.min.js" type="text/javascript"></script>
        <script src="/static/newassets/layouts/global/scripts/quick-nav.min.js" type="text/javascript"></script>
        <!-- END THEME LAYOUT SCRIPTS -->
        <script type="text/javascript" src="/static/app_js/current_update.js"></script>

		<script type="text/javascript">
			window.onload = function () {
				setValue();
			  }
		</script>
	


	<script>
var TableDatatablesEditable = function () {

    var handleTable = function () {

        function restoreRow(oTable, nRow) {
            var aData = oTable.fnGetData(nRow);
            var jqTds = $('>td', nRow);

            for (var i = 0, iLen = jqTds.length; i < iLen; i++) {
                oTable.fnUpdate(aData[i], nRow, i, false);
            }

            oTable.fnDraw();
        }

        function editRow(oTable, nRow) {
            var aData = oTable.fnGetData(nRow);
            var jqTds = $('>td', nRow);

            jqTds[2].innerHTML = '<select id ="role"><option value="Admin"'+(aData[2]=="Admin" ? " selected":"")+'>Admin</option><option value="Tenant"'+(aData[2]=="Tenant" ? " selected":"")+'>Tenant</option><option value="Guest"'+(aData[2]=="Guest" ? " selected":"")+'>Guest</option>'+(aData[2] == "Unapproved" ? '<option value="Unapproved" selected>Unapproved</option>' : "")+'</select>';
            jqTds[5].innerHTML = '<a class="btn green btn-xs edit" href="">Save</a><a class=" btn blue btn-xs cancel" href="">Cancel</a>';
        }

        function saveRow(oTable, nRow) {
            var jqInputs = $('select', nRow);

	    var values = [];
		var jqInputs = $('select', nRow);
		
		var from = oTable.fnGetData(nRow)[2];
		var to = jqInputs.val();
		var newto = to;

		var modify = (from != to);

		if(to == "Guest") {
			newto = "Tenant";		
		}
		else if(to == "Tenant") {
			newto = "Zone Manager";		
		}

		if(modify && (from != "Unapproved"))
		{
			var values = {
			       "data": [[nRow.id.substr(3), newto]]
			   };

			var jsonText = JSON.stringify(values);

			    console.log(jsonText);
			    $.ajax({
			      url : '/modify_user_permissions/',
			      type: 'POST',
			      data: jsonText,
			      contentType: "application/json; charset=utf-8",
			      dataType: 'json',
			      success : function(data) {
				oTable.fnUpdate(to, nRow, 2, false);
			      },
			      error: function(data) {
			          alert("Change role error");
				  oTable.fnUpdate(from, nRow, 2, false);
			      }
			     });
		}
		else if(modify && (from == "Unapproved"))
		{
			var values = {
			       "data": [[nRow.id.substr(3), "true", newto]]
			   };

			var jsonText = JSON.stringify(values);

		    	console.log(jsonText);

			$.ajax({
			  url : '/approve_users/',
			  type: 'POST',
			  data: jsonText,
			  contentType: "application/json; charset=utf-8",
			  dataType: 'json',
			  success : function(data) {
				oTable.fnUpdate(to, nRow, 2, false);
			  },
			  error: function(data) {
				alert("Change role error");
				oTable.fnUpdate(from, nRow, 2, false);
			  }
			 });
			    
		}

            oTable.fnUpdate('<a class="btn yellow-saffron btn-xs edit" href="">Edit</a>', nRow, 5, false);
            oTable.fnUpdate('<a class="btn red btn-xs delete" href="">Delete</a>', nRow, 6, false);
            oTable.fnDraw();
        }


        var table = $('#sample_editable_1');

        var oTable = table.dataTable({

            // Uncomment below line("dom" parameter) to fix the dropdown overflow issue in the datatable cells. The default datatable layout
            // setup uses scrollable div(table-scrollable) with overflow:auto to enable vertical scroll(see: assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.js).
            // So when dropdowns used the scrollable div should be removed.
            //"dom": "<'row'<'col-md-6 col-sm-12'l><'col-md-6 col-sm-12'f>r>t<'row'<'col-md-5 col-sm-12'i><'col-md-7 col-sm-12'p>>",

            "lengthMenu": [
                [5, 15, 20, -1],
                [5, 15, 20, "All"] // change per page values here
            ],

            // Or you can use remote translation file
            //"language": {
            //   url: '//cdn.datatables.net/plug-ins/3cfcc339e89/i18n/Portuguese.json'
            //},

            // set the initial value
            "pageLength": 5,

            "language": {
                "lengthMenu": " _MENU_ records"
            },
            "columnDefs": [{ // set default column settings
                'orderable': true,
                'targets': [0]
            }, {
                "searchable": true,
                "targets": [0]
            }],
            "order": [
                [0, "asc"]
            ] // set first column as a default sort by asc
        });

        var tableWrapper = $("#sample_editable_1_wrapper");

        var nEditing = null;
        var nNew = false;


        table.on('click', '.delete', function (e) {
            e.preventDefault();

            if($(this).attr("disabled"))
		return;

            if (confirm("Are you sure to delete this row ?") == false) {
                return;
            }

            var nRow = $(this).parents('tr')[0];
	    
            values = {
               "id": nRow.id.substr(3)
            };
            var jsonText = JSON.stringify(values);

            console.log(jsonText);
            $.ajax({
			  url : '/delete_user/',
			  type: 'POST',
			  data: jsonText,
			  contentType: "application/json; charset=utf-8",
			  dataType: 'json',
			  success : function(data) {
				oTable.fnDeleteRow(nRow);
				alert("User successfully deleted");
			  },
			  error: function(data) {
				alert("User delete error");
			  }
			 });
        });

        table.on('click', '.cancel', function (e) {
            e.preventDefault();
            if (nNew) {
                oTable.fnDeleteRow(nEditing);
                nEditing = null;
                nNew = false;
            } else {
                restoreRow(oTable, nEditing);
                nEditing = null;
            }
        });

        table.on('click', '.edit', function (e) {
            e.preventDefault();
            nNew = false;

	    if($(this).attr("disabled"))
		return;

            /* Get the row as a parent of the link that was clicked on */
            var nRow = $(this).parents('tr')[0];

            if (nEditing !== null && nEditing != nRow) {
                /* Currently editing - but not this row - restore the old before continuing to edit mode */
                restoreRow(oTable, nEditing);
                editRow(oTable, nRow);
                nEditing = nRow;
            } else if (nEditing == nRow && this.innerHTML == "Save") {
                /* Editing this row and want to save it */
                saveRow(oTable, nEditing);
                nEditing = null;
            } else {
                /* No edit in progress - let's start one */
                editRow(oTable, nRow);
                nEditing = nRow;
            }
        });
    }

    return {

        //main function to initiate the module
        init: function () {
            handleTable();
        }

    };

}();

jQuery(document).ready(function() {
    TableDatatablesEditable.init();
	$.csrftoken();
});
	</script>
    </body>

</html>
